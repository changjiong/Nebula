# Nebula 星图（Talos）- 简化版产品与架构说明

> **更新**: 2026-01-27  
> **目的**: 去掉实现细节与代码示例，保留“架构/功能/逻辑/模型/界面/API/规划/进度”，用于全局把握项目。  
> **对照**: 详细版见 `docs/implementation_plan.md`（以仓库代码为事实来源）。
> **项目推进**: 任务拆解与排期见 `docs/project_execution_plan.md`。

---

## 1. 产品定位（做什么 / 不做什么）

### 1.1 问题与目标

银行业务人员常见工作（企业信息查询、客户价值评估、交易对手/关系分析、舆情与风险线索）分散在多个系统与口径中，存在：

- 获取慢：跨系统检索、复制粘贴与手动拼接
- 质量不稳：口径不一、信息遗漏、难以追溯
- 成本高：依赖个人经验，难以规模化复用

Nebula（星图）提供统一智能入口：用自然语言触发“意图识别 → 工具/技能编排 → 结果可视化呈现 → 可追溯可复用”。

### 1.2 范围边界

| ✅ 我们做（平台能力） | ❌ 我们不做（边界） |
|---|---|
| 自然语言交互入口与对话工作台 | 数据仓库建设/治理的全部工作 |
| 多模型统一网关与调用策略 | 模型训练、部署与推理平台 |
| Tool/Skill/Agent 知识工程管理 | 用一个平台替代所有既有业务系统 |
| 端到端编排执行（NFC/ReAct Loop） | 大规模离线 ETL/批处理平台 |
| 结构化结果渲染与产出物（Canvas/Artifact） | 文档系统/报表系统的完全替代 |

---

## 2. 核心概念（统一口径）

| 概念 | 一句话定义 | 典型产出 |
|---|---|---|
| **Tool（工具）** | 最小可调用能力单元（有明确输入/输出契约） | 企业查询、评分模型调用、关系图计算 |
| **Skill（技能）** | 多 Tool 的可复用流程（DAG/工作流） | “企业全景分析”流程 |
| **Agent（业务代理）** | 面向场景的“策略 + 可用能力集合 + 输出模板” | “科创评价专家”“交易对手分析师” |
| **Model Provider** | LLM 服务商与模型配置（多模型统一入口） | OpenAI/DeepSeek/Claude 等 |
| **Conversation/Message** | 会话与消息（含追溯信息：思维链/工具调用） | 可回放执行过程 |
| **Artifact（产出物）** | 可保存/编辑/导出的结构化结果 | 报告、表格、图谱、Markdown |
| **Data Standards** | 数据标准表/字段及与工具输出的映射 | 数据血缘图、字段口径一致性 |

---

## 3. 端到端体验（用户看到什么）

### 3.1 典型旅程（客户经理）

1. 在对话页输入需求（例如“分析某企业授信风险与关系网络”）
2. 系统展示可追溯过程：意图识别、步骤拆解、工具调用与结果摘要
3. 主消息区给出“结论 + 关键依据 + 风险提示 + 下一步建议”
4. Canvas 区呈现可编辑产出物（报告/表格/图谱），支持导出与复用

### 3.2 关键交互点（必须清晰）

- **可追溯**：每次工具调用/结果都可展开查看来源与参数（用于审计与复核）
- **可控**：需要时可要求用户补齐关键参数（Human-in-the-loop 入口）
- **可复用**：把一次成功的分析沉淀为 Skill/Agent，提高复用效率

---

## 4. 架构总览（分层 + 组件）

### 4.1 分层架构

| 层 | 目标 | 主要能力 |
|---|---|---|
| **交互层（Frontend）** | 让用户“看得懂、可追溯、可编辑” | 对话、思维链、动态组件、Canvas |
| **API 层（Backend）** | 把交互与执行能力稳定对外提供 | REST + SSE 流式 |
| **编排运行时（Engine）** | 把自然语言变成可执行流程并稳定运行 | Planner、Executor、Memory、校验/重试 |
| **知识工程层（Models）** | 把能力以资产形式管理与复用 | Tool/Skill/Agent、权限、版本、统计 |
| **服务适配层（Adapters）** | 对接 LLM/数据/模型/外部系统 | LLM Gateway、外部 API、数仓、模型平台 |
| **存储层（DB/Cache）** | 持久化与共享 | PostgreSQL（规划 Redis 共享记忆/缓存） |

### 4.2 核心组件与职责（代码定位）

| 组件 | 职责 | 代码入口（事实来源） |
|---|---|---|
| **LLM Gateway** | 多模型统一调用、选择与兜底策略 | `backend/app/llm/gateway.py` |
| **Planner** | 意图识别、参数提取、生成下一步动作 | `backend/app/engine/planner.py` |
| **NFC/ReAct Engine** | 循环：规划 → 调用工具 → 观察 → 继续/结束 | `backend/app/engine/nfc_graph.py` |
| **Tool Executor** | 根据 Tool 定义动态执行（内置/外部/模型/数仓） | `backend/app/engine/tool_executor.py` |
| **Memory** | 会话上下文与短期记忆 | `backend/app/engine/memory.py` |
| **Streaming（SSE）** | 统一事件输出：过程/结果/组件/产出物 | `backend/app/api/routes/chat.py` |

### 4.3 运行时主链路（逻辑视图）

用户输入 → Planner 产出“下一步动作/工具调用” → Executor 执行工具 → 结果回填对话上下文 → LLM 整合生成输出 → SSE 按事件流推送前端（过程、工具调用、结果、组件、最终消息、完成/错误）。

### 4.4 技术基线与已知差异（对齐代码）

**技术栈（当前）**

| 层 | 技术 |
|---|---|
| 前端 | React + TypeScript + Vite |
| 路由/状态 | TanStack Router + Query + Zustand |
| UI/可视化 | Chakra UI + ReactFlow |
| 后端 | FastAPI + SQLModel |
| 数据库 | PostgreSQL |
| 编排 | LangGraph |
| 部署 | Docker Compose（含 Coolify 版本） |

**已知差异/技术债（需要收敛）**

- Memory 仍以进程内为主，暂不支持多副本共享（规划引入 Redis）
- 权限判定口径存在不一致风险（`public/department/role` 与实际判定需统一）
- Provider presets 与 Adapter 支持不完全一致（部分 provider_type 选择后可能失败）
- 前端 `/tools`、`/skills` 仍存在“页面骨架/Mock”为主的区域，需完成真对接与可视化编排落库

---

## 5. 领域模型（逻辑模型，不含代码）

### 5.1 关键实体与关系

- **User**：拥有 `department`/`roles`，影响可见与可用能力
- **ModelProvider**：服务商/模型/鉴权配置，供 LLM Gateway 选择
- **Tool**：输入/输出契约 + 执行类型 + 权限 + 统计
- **Skill**：工作流定义（节点/依赖/映射）+ 权限 + 版本
- **Agent**：场景策略（系统提示词/输出模板/可用工具技能集合）+ 权限
- **Conversation/Message**：会话与消息；消息可携带“思维链/工具调用回放信息”
- **StandardTable/TableField**：数据标准表与字段口径
- **ToolDataMapping**：工具输出字段 ↔ 标准字段映射，用于血缘与可解释

### 5.2 权限模型（统一口径）

目标口径：`public / department / role` 三层可见性；后端过滤与前端展示需一致，并以用户的部门/角色为判定依据。  
当前已知风险：权限判定存在口径不一致（需要在路线图 P0 收敛）。

---

## 6. 功能模块清单（从产品到工程的对齐）

### 6.1 对话与执行（核心闭环）

- 用户通过对话触发任务；系统通过 SSE 推送过程与结果
- 支持多轮：可追问、可补参、可继续调用工具
- 支持结构化渲染：后端返回组件/产出物，前端按类型渲染

### 6.2 工具（Tool）管理

- 目标：让“能力资产化”，可配置、可测试、可授权、可观测
- 必备能力：CRUD、Schema 管理、在线测试、调用统计、血缘关联

### 6.3 技能（Skill）编排

- 目标：把“多步分析流程”变成可复用流程资产
- 必备能力：可视化编排（DAG）、参数映射、输出映射、版本与回放

### 6.4 代理（Agent）配置

- 目标：面向业务场景提供“可用能力集合 + 输出风格/模板 + 行为约束”
- 必备能力：选择可用 Tool/Skill、系统提示词管理、默认模型策略、权限

### 6.5 模型服务商（Model Providers）

- 目标：可视化配置多模型，统一接入与运维（可用性/限流/成本）
- 必备能力：配置管理、可用性检测、路由策略、兜底策略一致性

### 6.6 数据标准与血缘（Data Standards）

- 目标：解决“字段口径不一致”和“输出不可解释”的问题
- 必备能力：标准表/字段管理、字段映射、血缘图展示、数据质量提示

### 6.7 Canvas / Artifact（产出物工作台）

- 目标：让分析结果“可编辑、可沉淀、可导出、可复用”
- 必备能力：产出物列表与版本、编辑、导出、与思维链步骤关联

---

## 7. API 与事件协议（面向对接）

### 7.1 REST API（按域划分）

| 域 | 端点（示例） | 说明 |
|---|---|---|
| 对话 | `POST /api/v1/chat/stream` | SSE 流式对话（核心） |
| 工具 | `GET/POST /api/v1/tools` | 工具列表/创建 |
| 技能 | `GET/POST /api/v1/skills` | 技能列表/创建 |
| 代理 | `GET/POST /api/v1/agents` | Agent 列表/创建 |
| 模型 | `GET/POST /api/v1/model-providers` | 服务商配置 |
| 标准 | `GET/POST /api/v1/standard-tables` | 标准表管理 |
| 血缘 | `GET /api/v1/tools/{tool_id}/data-graph` | 工具与标准字段血缘 |

### 7.2 SSE 事件（对前端最关键的契约）

建议统一以下语义（命名可复用现有实现）：

- `thinking`：当前步骤/意图/下一步计划（用于思维链 UI）
- `tool_call`：即将调用的工具（包含 name/id/状态）
- `tool_result`：工具结果摘要（含成功/失败与可读预览）
- `component`：结构化组件渲染指令（前端按 `component_type` 渲染）
- `artifact`：产出物（进入 Canvas 编辑与导出）
- `message`：自然语言总结（最终回答或阶段性说明）
- `done` / `error`：任务结束与错误收敛

---

## 8. 界面与组件（信息架构）

### 8.1 页面结构（面向角色）

| 页面 | 目标 | 核心用户 |
|---|---|---|
| `/` | 对话与任务执行主入口 | 所有人 |
| `/agents` | 场景封装与发布 | 产品经理 |
| `/tools` | 能力资产化管理 | 产品经理/开发 |
| `/skills` | 流程编排与复用 | 产品经理/开发 |
| `/model-providers` | 多模型配置与运维 | 管理员/平台 |
| `/data-standards` | 数据口径与血缘 | 产品经理/数据 |

### 8.2 前端渲染原则（保证可扩展）

- **组件注册表**：后端返回 `component_type + props`，前端负责渲染实现
- **同构体验**：对话消息给“结论”，Canvas 给“可编辑结果”，思维链给“可追溯过程”

### 8.3 动态组件（典型类型）

| `component_type`（示例） | 用途 |
|---|---|
| `enterprise_card` | 企业信息卡片 |
| `score_radar` | 评分雷达图 |
| `relation_graph` | 关联关系网络 |
| `table` | 结构化表格 |
| `markdown` | 富文本内容 |
| `form` | 补参/确认等交互表单 |

---

## 9. 统一路线图（解决 Phase/阶段混乱）

为避免“路线图（Phase）”与“任务阶段（阶段一～四）”重复/冲突，统一采用一个维度：**里程碑（M）**；每个里程碑包含交付物与验收口径。

| 里程碑 | 目标 | 验收口径（简） |
|---|---|---|
| **M0 基线** | 代码现状可运行 | 前后端可用，SSE 可流式 |
| **M1 核心稳定** | 修复阻塞性技术债 | 权限口径统一；模型适配/兜底不“选了就报错”；Engine 入口收敛 |
| **M2 知识工程 MVP** | Tool/Skill/Agent 可管理可测试 | `/tools`、`/skills` 真对接；Skill 可视化编排落库 |
| **M3 数据标准 MVP** | 口径与血缘可用 | 标准表编辑完善；映射与血缘图可闭环 |
| **M4 产出物工作台 MVP** | 结果可编辑可导出 | Artifact 事件 → Canvas 编辑 → 导出/保存 |
| **M5 业务包 1.0** | 业务可落地复用 | 3–5 Tool + 2–3 Skill + 2 Agent 在真实场景可用 |
| **M6 生产化** | 可观测可审计可扩展 | 指标/日志/审计/限流；共享记忆与多副本支持（Redis） |

---

## 10. 当前进度（以“阻塞优先级”管理）

### P0（阻塞闭环/影响正确性）

- 权限口径收敛：`public/department/role` 全链路一致
- Provider/Adapter 对齐：预置项不可选择即失败；明确兜底策略

### P1（影响效率/影响扩展）

- `/tools`、`/skills` 从 Mock → 真对接；补齐测试/发布/版本能力
- Engine 流程入口收敛（减少维护面）

### P2（体验与业务增量）

- Canvas/Artifact 体验完善（编辑、版本、导出）
- 业务工具与技能包持续沉淀
